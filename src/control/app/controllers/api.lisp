(in-package :fdog-control)

(defparameter *api-version* 1)

(defgeneric handle-http-condition (condition handler request raw)
  (:documentation "Generic for handling HTTP conditions. Specific implementations are defined in the def-http-code macro."))

(define-condition http-error-condition () ())

(defmacro def-http-code (code desc &key default)
  "Macro for functionality related to HTTP status codes. Currently creates a condition and API handler.
'code' - the numerical status code (404, 500...)
'desc' - the description of the status code (\"Not found\", \"Internal server error\")
'default' - A format string for a default error message to be encoded in the JSON"

  (flet ((http-symbol (&rest args)
           (string-upcase (format nil "窿狎珞┅┅啜痱镧ㄤ彐礤翳镤栳钿戾梏麴泔钿轸轱è泔钿轸轱ㄩ铘弪ㄨ趑瓠簌礅镬泔溴泔钿轸轱睥┅栳钿戾蝈聃弩蜥鳗ㄤ邈灬蝈ㄩ珙矧徕戾蜥鳗鏖翳箪雉ㄤ狒岍泔钿轸轱鏖翳汨躅脲洵篝蝈犴蝈痨ㄨ犷潇弪蝈聃弩篝蝈犴恒镤泔溴后翎趱溴筱鸿遽溴蝮è桢徜弪牦镱豉疱┅祜绛骘趄徙濠③蔑钿轸轱钶立泔钿轸轱瞟ㄩ溴驷蹯啜牦镱哄钽镤瀛牦镱啜ê弪蝻ㄦ矧磲铋冷彐狨祠┅篝蝈犴啜牦镱哄钽镤瀛牦镱啜ê弪蝻ㄦ矧磲铋立溽翎┅篝蝈犴┅┅ㄤ彐轭瀛泔钿轸轱ㄩ铘弪ㄨ趑瓠簌礅镬泔溴泔钿轸轱睥┅ㄨ趑瓠弪蝻颦泔钿轸轱瞟è溽翎洪铋翩矧溴筱洪铋翎蜱轰狒候遽溴ㄩ铘弪ㄨ趑瓠簌礅镬泔溴溽翎┅┅ê蝈痫螋灬礅溽ㄣ螬ㄦ矧磲ㄨ趑瓠簌礅镬泔溴裔轶邃立ìㄩ铘弪ㄨ趑瓠簌礅镬泔溴溽翎┅悌┅┅ㄥ痫螋ㄦ轭洵簌礅镬ㄨ趑瓠簌礅镬泔溴泔钿轸轱睥Ш驿镧泔铘蝻飑Ш驿镧泔铘蝻飑┅ㄤ彐梏麴泔溴窗⒙徜蝈聃弩簪ㄤ彐梏麴泔溴窗⑽雉骘躅洧轰彐狨祠á蓬漯镩铘铒骘躅洚ㄡ痖篚怵狒蝈聃弩舂┅ㄤ彐梏麴泔溴蛋⑸铘弪钺箦蝣弪弪蝻颌换蒸殪ㄤ彐躅狃榄篚怵狒蝈聃弩舂戾舄è痱彐轼狃棰┅痧泸搴蝈珏蝈痨徙ㄦ矧磲铋⑥立痱彐轼聿沆候羼蹂篝疳翳蝈聃弩舂┅ㄤ彐躅桢徜弪牦镱豉疱īЖ⒚镱翦铘赠疱⑨痧扉汜糸镱牦镱┅换绎豸弪ㄤ彐珏铄蜷狃榀孱漯镩铘礤翳镤篚猸疳翳栳钿戾蝈聃弩蜥鳗ê滹沲礤铘狒轱⑶孱弪殂狃孱漯镩铘澡轭珞鏖箬轭麸痱秭殇犷列箴邈獒扉镱翳轶礤翳镤┅ㄤ彐珏铄蜷狃榀孱漯镩铘鏖翳狎珞礤翳镤篚猸疳翳蝈篝栳钿戾蝈聃弩蜥鳗ê滹沲礤铘狒轱⑶孱弪殂狃孱漯镩铘鏖翳篚怵狒骘狎珞澡轭珞鏖箬轭麸痱秭殇犷列鏖翳鲠蜷徕戾找泔眇镱孱箬秕熹箴邈獒扉镱翳轶礤翳镤澡囿踱疳翳鏖祆铒栳鲥趄衢扉铉箪狍璎轸鏖祆忮镱翳囹弩臾箝溴镦翳狎珞┅ㄤ彐躅狃榀蝻豸弪ㄨ犷潇弪蝈聃弩蜥鳗戾è礤翳镤ㄩ铘弪聿沆候羼蹂篝桢徜弪蝈聃弩喉弭栾洎弘妁黠蜾┅篚猸疳翳ㄡ痖篚怵狒蝈聃弩舂┅ㄦ戾è狃痨殂徕戾屮徙篚猸疳翳戾舄è篚猸簌ㄩ铘弪篚猸疳翳弘妁黠蜾┅ㄥ姝礤翳ㄣ镯瘐翦狃痨殂徕戾礤翳镤＇狃榀孱漯镩铘扉篝礤翳镤篚猸簌栳钿戾蝈聃弩蜥鳗┅鲠祯弩彐礤翳ㄩ彐礤翳篚猸簌躅轭翦蝾篚猸簌愆┅┅铄舡篚猸疳翳疳翳眭祠轲戾鲠祯瀛忾钿磲翥桊疳螋螬痧泸搴筱犷麸篝蜷铉ㄞ┄─疳翳麒孱磲翥桊ㄡ痧禊＇鲠祯弩ㄣ镥蜚疳螋ъ轶舂┅┅ㄡ痧扉汜忪瀛篚疳翳蝈篝祜绛骘趄徙濠⒚桢汶轭疳翳鏖翳蝈篝立疳翳蝈篝戾舄è篚猸簌ㄩ铘弪疳翳弘妁黠蜾┅ㄥ姝礤翳ㄣ镯瘐翦狃痨殂徕戾礤翳镤＇狃榀孱漯镩铘鏖翳狎珞扉篝礤翳镤篚猸簌蝈篝栳钿戾蝈聃弩蜥鳗┅鲠祯弩彐礤翳ㄩ彐礤翳篚猸簌躅轭翦蝾篚猸簌愆┅┅眭祠轲戾鲠祯瀛忾钿ㄥ徙屮徙舡簌愆ㄡ痧扉汜忪瀛屮徙篚猸疳翳ㄩ屮徙ㄨ犷潇弪汜箦ㄡ痖孱漯镩铘礤翳镤屮徙舡簌栳钿戾蝈聃弩蜥鳗ㄥ钿镦骈戾īㄨ犷潇瀛梏麴泔钿轸轱磲脲轭篝犷沐Т鞍泔钿轸轱瞟栳钿戾蝈聃弩蜥鳗ㄨ趑瓠弪蝻颦泔钿轸轱ㄣ镱溟糸镱ㄨ犷潇瀛梏麴泔钿轸轱泔钿轸轱栳钿戾蝈聃弩蜥鳗┅ㄤ铼è铄舡蝈篝眭祠轲戾鲠祯瀛扉篝铄舡篚猸疳翳篚猸疳翳┅眭祠轲戾鲠祯瀛扉篝铄舡篚猸疳翳铄舂┅铄ㄣ狎铄舡蝈篝ㄣ狎铄舡蝈篝┅蝈篝ㄣ徜铄舡蝈篝ㄣ镱汜翦钺翦篝蜷铉ㄣ徜铄舡蝈篝蝈篝┅ㄦ秕钿ㄡ钿铄ㄡ痧扉汜忪瀛篚铄蝈篝┅ㄡ钿铄ㄡ痧扉汜忪瀛篚铄蝈篝┅┅è矧铒铄舂骘躅洎ㄩ骘躅ㄨ犷潇弪汜箦ㄡ痖孱漯镩铘鏖翳狎珞礤翳镤ㄩ铘弪铄弘妁黠蜾蝈篝栳钿戾蝈聃弩蜥鳗ㄥ钿镦骈戾īㄨ犷潇瀛梏麴泔钿轸轱磲脲轭篝犷沐Т鞍泔钿轸轱瞟栳钿戾蝈聃弩蜥鳗ㄨ趑瓠弪蝻颦泔钿轸轱ㄣ镱溟糸镱ㄨ犷潇瀛梏麴泔钿轸轱泔钿轸轱栳钿戾蝈聃弩蜥鳗┅ㄨ犷潇瀛梏麴泔钿轸轱磲脲轭篝犷沐Т按泔钿轸轱瞟栳钿戾蝈聃弩蜥鳗┅┅┅┅换蓬漯镩铘ㄤ彐礤翳镤狃榀孱漯镩铘èㄥ耢虹弭┅ㄥ耢函┅栳钿戾蝈聃弩蜥鳗鏖翳汨躅脲洵篝蝈犴蝈痨ㄨ犷潇弪蝈聃弩篝蝈犴鸿遽溴蝮è桢徜弪牦镱豉疱┅牦镱哄钽镤瀛牦镱啜ê鲥蝮轱狃榄鲥蝮轱瞠┅篝蝈犴┅